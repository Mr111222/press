<template lang="pug">
  cbm-select(
    v-if="initOver"
    :selectDatas="selectDatas"
    :selecteds="selectedDatas"
    :title="title"
    @action="done"
  )
</template>
<script>
  import {formatToData, makeDate, dateToObj} from '../lib/main'
  export default {
    name: 'CbmDatePicker',
    props: {
      title: {
        type: String,
        default: '选择日期'
      },
      format: {
        type: String,
        default: 'yyyy-MM-dd' // yyyy-MM-dd hh:mm:ss
      },
      yearRange: Array,
      value: String
    },
    data () {
      return {
        initOver: false, // 在数据初始化完后再展示界面，以避免有错误时显示空白界面
        selectDatas: [],
        selectKeys: [],
        selectedDatas: {},
        yearNo: null,
        monthNo: null,
        dateNo: null
      }
    },
    created () {
      const dateConfig = formatToData(this.format, this.value, this.yearRange)

      const yearNo = dateConfig.keys.indexOf('year')
      const monthNo = dateConfig.keys.indexOf('month')
      const dateNo = dateConfig.keys.indexOf('date')
      if (dateNo > -1) {
        if (yearNo === -1 || monthNo === -1) {
          throw new Error('不能在不设置年月的情况下单独设置日期')
        } else {
          this.yearNo = yearNo
          this.monthNo = monthNo
          this.dateNo = dateNo
        }
      }

      this.selectDatas = dateConfig.datas
      this.selectKeys = dateConfig.keys
      this.selectedDatas = dateConfig.result
      this.initOver = true
    },
    methods: {
      setValue (type, opts) {
        this.$emit('action', opts)
      },
      change (target, data) {
        if (this.dateNo > -1) {
          if (target === this.yearNo || target === this.monthNo) {
            this.$set(this.selectDatas, this.dateNo, makeDate(data[this.yearNo].id, data[this.monthNo].id))
          }
        }
      },
      done (opts) {
        if (opts.type === 'change') {
          this.change(opts.target, opts.data)
        } else if (opts.type === 'submit') {
          this.$emit('action', {
            type: 'submit',
            data: dateToObj(opts.data, this.selectKeys, this.format)
          })
        } else if (opts.type === 'cancel') {
          this.$emit('action', {type: 'cancel'})
        }
      }
    }
  }
</script>
