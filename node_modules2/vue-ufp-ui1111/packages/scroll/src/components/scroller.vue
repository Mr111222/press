<template lang="pug">
  .cb-scroll-boxs
    .cb-scroll-pullup
      slot(name="pullup") {{pullupTxt}}
    .cb-scroll-list(ref="contain")
      .cb-scroll-main(:style="mainStyles" ref="wrapper")
        slot
        slot(name="loading" v-if="loading")
          .cb-scroll-down {{loadingTxt}}
        slot(name="pulldown" v-else-if="hasMoreData")
          .cb-scroll-down {{pulldownTxt}}
        slot(name="nodata" v-else)
          .cb-scroll-down {{nodataTxt}}
</template>
<script>
  import extend from 'lodash/extend'
  import Scroller from '../lib/scroller'
  export default {
    name: 'CbScroll',
    props: {
      pullupTxt: {
        type: String,
        default: '下拉刷新'
      },
      pulldownTxt: {
        type: String,
        default: '上拉加载更多'
      },
      loadingTxt: {
        type: String,
        default: '数据加载中'
      },
      nodataTxt: {
        type: String,
        default: '没有更多数据'
      },
      bgColor: String,
      scrollListener: Function,
      filterKey: String
    },
    computed: {
      mainStyles () {
        if (this.bgColor) {
          return {
            backgroundColor: this.bgColor
          }
        }
      }
    },
    data () {
      return {
        needRefresh: false,
        hasMoreData: false,
        isRefresh: false,
        loading: false,
        localPage: 0,
        status: 0, // 0:正常，1：刷新前，2：刷新中，3：刷新完成，4：加载更多前，5：加载更多中，6：加载更多完成，9：尚未初始化(废弃)
        scrollObj: undefined
      }
    },
    mounted () {
      this.$refs.wrapper.style.minHeight = `${this.$refs.contain.offsetHeight + 1}px`
      this.status = 'refresh'
      this.scrollObj = new Scroller(this.$refs.contain, this.changeStatus.bind(this), this.scrollListener)
    },
    updated () {
      if (this.needRefresh) {
        this.needRefresh = false
        this.scrollObj.refresh()
        if (this.hasMoreData && this.scrollObj.getY() > -2) { // 首次加载没有充满时，加载更多页
          this.status = 'loadmore'
        }
      }
    },
    watch: {
      filterKey (val, oldVal) {
        if (val !== oldVal) this.status = 'refresh'
      },
      status (val, oldVal) {
        if (val !== 3) { // 数据加载完成状态由外部触发，不需要通知外部
          let backData = {
            type: val
          }
          switch (val) {
            case 'refresh': // refresh
              this.localPage = 0
              this.loading = true
              backData = extend(backData, {
                cb: this.loadOver.bind(this)
              })
              break
            case 'loadmore': // load
              backData = extend(backData, {
                cb: this.loadOver.bind(this),
                page: this.localPage + 1
              })
              this.loading = true
              break
          }
          this.$emit('action', backData)
        }
      }
    },
    methods: {
      changeStatus (status) {
        if (this.loading) return // 在加载中时禁止任何更改
        if (!this.hasMoreData) { // 没有更多数据时禁止‘4：加载更多前，5：加载更多中’状态
          if (status === 'preload' || status === 'loadmore') return
        }
        this.status = status
      },
      loadOver (hasMore) {
        if (this.status === 'refresh') {
          this.scrollObj.finishPullDown()
        } else if (this.status === 'loadmore') {
          this.scrollObj.finishPullUp()
        }
        if (hasMore) this.scrollObj.openPullUp()
        else this.scrollObj.closePullUp()

        this.hasMoreData = !!hasMore
        this.loading = false
        this.localPage += 1
        this.status = 'nomral'
        this.needRefresh = true
      },
      filter () {
        this.status = 'refresh'
      }
    }
  }
</script>
