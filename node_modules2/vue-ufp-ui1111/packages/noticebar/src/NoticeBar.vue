<template>
  <div v-if="show" class="cb-class cb-notice-bar" :style="{color: fontColor, 'background-color': backgroundColor}">
    <div v-if="iconShow" class="cb-notice-bar-icon cb-icon cb-icon-volume-medium" :style="{'background-color': backgroundColor}"></div>
    <div class="cb-notice-bar-content-wrap" ref="contentWrap">
      <div class="cb-notice-bar-content" ref="content">
        <slot></slot>
      </div>
    </div>
    <div v-if="closeButtonShow" class="cb-notice-bar-operation" @click="handleClose" :style="{'background-color': backgroundColor}">
      <div class="cb-icon cb-icon-ios-close-empty"></div>
    </div>
  </div>

</template>

<script>
  /*eslint-disable */
  export default {
    name: 'cb-notice-bar',
    props: {
      // 自定义背景颜色
      backgroundColor: {
        type: String,
        default: '#fefcec'
      },
      // 自定义字体颜色
      fontColor: {
        type: String,
        default: '#f76a24'
      },
      // 图标是否显示
      iconShow: {
        type: Boolean,
        default: true
      },
      // 关闭按纽是否显示
      closeButtonShow: {
        type: Boolean,
        default: false
      },
      // 滚动速度,为0不滚动
      speed: {
        type: Number,
        default: 0
      }
    },
    data() {
      return {
        show: true,
        animationTimer: null,
        loopTimer: null
      }
    },
    mounted() {
      if (this.speed !== 0) {
        this.startAnimation();
      }
    },
    beforeDestroy() {
      this.destroyTimer();
    },
    methods: {
      startAnimation() {
        let that = this;
        const width = this.$refs.content.clientWidth;
        const wrapWidth = this.$refs.contentWrap.clientWidth;
        const moveDistance = width + wrapWidth;
        const duration = width / 40 * this.speed;
        const start = wrapWidth;
        const end = -width;
        let current = start;
        let step = moveDistance / duration * 16;
        this.$refs.content.style.left = `${current}px`;
        (function fn() {
          if (current > end) {
            current = current - step;
            that.$refs.content.style.left = `${current}px`;
            that.animationTimer = setTimeout(fn, 17)
          } else {
            that.startAnimation();
          }
        })();
      },
      destroyTimer() {
        if (this.animationTimer) {
          clearTimeout(this.animationTimer)
        }
      },
      handleClose() {
        this.destroyTimer();
        this.show = false;
        this.$emit('closeButtonClick')
      }
    }
  }
</script>

