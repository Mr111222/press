<template lang="pug">
transition(:name="transition")
  layer(:style="boxStyles" v-if="!complete")
    header.cbm-select-header
      a.close(@click="cancel") {{closeText}}
      a.sure(@click="submit") {{sureText}}
      h2.title {{title}}
    ul.row-title(v-if="rowTitle")
      li(
        v-for="(item,index) in rowTitle"
        :style="getRowStyle(index)"
      ) {{item}}
    .cbm-select-box
      srcoll(
        v-for="(item,index) in innerDatas"
        :datas="item"
        :key="index"
        :selected="selectedOrders[index]"
        @change="change"
        :styles="getRowStyle(index,true)"
        :lineHeight="lineHeight"
        :target="index"
        :blankRow="blankRow"
      )
    //- 注意，下面两行不能用一个div的上下边框实现，会造成按住中间没法拖动
    hr.cover-area1(:style="areaStyles1")/
    hr.cover-area2(:style="areaStyles2")/
    .loading-box(v-if="isLoading")
      .loading
</template>
<script>
  import isArray from 'lodash/isArray'
  import isInteger from 'lodash/isInteger'
  import isObject from 'lodash/isObject'
  import {initSelectedDatas} from '../lib/util'
  import layer from './layer'
  import srcoll from './scroll'
  // const prefixCls = 'cb-mselect'

  export default {
    name: 'CbmSelect',
    components: {layer, srcoll},
    props: {
      // 下拉框列表数据
      selectDatas: {
        type: Array,
        required: true,
        validator (v) {
          for (let i = 0; i < v.length; i++) {
            const item = v[i]
            if (!isArray(item)) {
              console.error('the data must be array!')
              return false
            }
          }
          return true
        }
      },
      // 选中项或者选中项序号，可以为[int]或[Object]
      selecteds: {
        type: Array,
        validator (v) {
          for (let i = 0; i < v.length; i++) {
            const item = v[i]
            if (!isInteger(item) && !isObject(item)) {
              console.error('the data must be int or object!')
              return false
            }
          }
          return true
        }
      },
      partDatas: Array,
      title: {
        type: String,
        default: ''
      },
      rowTitle: Array,
      itemHeight: {
        type: Number,
        default: 35
      },
      itemShowCount: {
        type: Number,
        validator (v) {
          if ([3, 5, 7, 9].indexOf(v) === -1) {
            console.error('只能同时展示3、5、7或9行!')
            return false
          }
          return true
        },
        default: 7
      },
      headerHeight: {
        type: Number,
        default: 44
      },
      relation: {
        type: Array
      },
      transition: String,
      isLoading: {
        type: Boolean,
        default: false
      },
      closeText: {
        type: String,
        default: '取消'
      },
      sureText: {
        type: String,
        default: '确定'
      }
    },
    computed: {
      lineHeight () {
        if (this.itemHeight !== 35) return this.itemHeight
      },
      boxStyles () {
        let boxHeight = this.itemHeight * this.itemShowCount + this.headerHeight
        if (this.rowTitle) boxHeight += this.itemHeight
        return {
          height: boxHeight + 'px'
        }
      },
      areaStyles1 () {
        const coverAreaTop = Math.floor(this.itemShowCount / 2)
        let top = this.headerHeight + this.itemHeight * coverAreaTop
        if (this.rowTitle) top += this.itemHeight
        return {top: top + 'px'}
      },
      areaStyles2 () {
        const coverAreaTop = Math.floor(this.itemShowCount / 2)
        let top = this.headerHeight + this.itemHeight * (coverAreaTop + 1)
        if (this.rowTitle) top += this.itemHeight
        return {top: top + 'px'}
      },
      blankRow () {
        return (this.itemShowCount - 1) / 2
      }
    },
    created () {
      this.innerDatas = this.selectDatas
      this.initData()
    },
    watch: {
      partDatas (val, oldVal) {
        for (let i = 0; i < val.length; i++) {
          const item = val[i]
          if (isArray(item)) {
            this.$set(this.innerDatas, i, item)
            this.$set(this.selectedOrders, i, 0)
          }
        }
      },
      selecteds (val, oldVal) {
        this.initData()
      }
    },
    data () {
      return {
        selectedOrders: [], // 已经选择的数据序号，初始化滑动组件时使用，并隔离数据的差异性
        // selectedDatas: [],
        innerDatas: [], // 内部使用的数据，隔离组件域
        complete: false
      }
    },
    methods: {
      initData () {
        // 处理已选择元素及其序号
        const selectedData = initSelectedDatas(this.selectDatas, this.selecteds)
        this.selectedOrders = selectedData.order
        // this.selectedDatas = selectedData.data
      },
      getRowStyle (order, isMult) {
        const width = 100 / this.selectDatas.length
        const height = isMult ? this.itemHeight * this.itemShowCount : this.itemHeight
        const left = width * order
        return {
          width: width + '%',
          left: left + '%',
          height: height + 'px'
        }
      },
      getSelectedData () {
        let selectedDatas = []
        for (let i = 0; i < this.selectedOrders.length; i++) {
          const localSelectOrder = this.selectedOrders[i]
          selectedDatas.push(this.innerDatas[i][localSelectOrder])
        }
        return selectedDatas
      },
      change (obj) {
        const {target, order} = obj
        this.selectedOrders[target] = order
        // this.selectedDatas[target] = value
        this.action('change', target, this.getSelectedData())
      },
      cancel: function () {
        this.action('cancel', null, null)
        this.complete = true
      },
      submit () {
        this.action('submit', null, this.getSelectedData())
        this.complete = true
      },
      action (type, target, data) {
        this.$emit('action', {
          type,
          target,
          data
        })
      }
    }
  }
</script>
